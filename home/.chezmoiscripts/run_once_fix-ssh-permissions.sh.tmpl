#!/usr/bin/env bash
{{- if or (eq .chezmoi.os "linux") (eq .chezmoi.os "darwin") -}}
# Ensure strict permissions on SSH directory and keys
set -euo pipefail

SSH_DIR="$HOME/.ssh"
mkdir -p "$SSH_DIR"
chmod 700 "$SSH_DIR"

# Fix permissions for private keys (no .pub extension)
if compgen -G "$SSH_DIR/*" > /dev/null; then
  # Private keys: 600
  find "$SSH_DIR" -maxdepth 1 -type f \
    ! -name "*.pub" \
    ! -name "known_hosts*" \
    ! -name "config" \
    -exec chmod 600 {} +
  # Public keys: 644
  find "$SSH_DIR" -maxdepth 1 -type f -name "*.pub" -exec chmod 644 {} +
fi

# SSH config should be 600 if present
if [ -f "$SSH_DIR/config" ]; then
  chmod 600 "$SSH_DIR/config"
fi

# known_hosts can be 644
if [ -f "$SSH_DIR/known_hosts" ]; then
  chmod 644 "$SSH_DIR/known_hosts"
fi
{{- end -}}
