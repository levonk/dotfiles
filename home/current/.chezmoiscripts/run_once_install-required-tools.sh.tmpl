#!/usr/bin/env bash
# shellcheck shell=bash
# vim: set filetype=sh ts=2 sw=2 et:
# -*- mode: sh; sh-basic-offset: 2; indent-tabs-mode: nil; -*-
# Managed by chezmoi. Installs external tools required by some templates.
# This runs once on the target machine when applying dotfiles, unless skipped.
#
# Behavior:
# - Skips if CHEZMOI_INSTALL_PKGS=0 (opt-out for CI/containers/tests)
# - Installs jq if missing, using the detected package manager
# - Safe to re-run; no-op when jq is already present

set -euo pipefail

# Respect opt-out in CI or where package installs are undesired
if [ "${CHEZMOI_INSTALL_PKGS:-1}" = "0" ]; then
  echo "[chezmoi] Skipping package installation (CHEZMOI_INSTALL_PKGS=0)"
  exit 0
fi

# If already present, nothing to do
if command -v jq >/dev/null 2>&1; then
  echo "[chezmoi] jq already installed"
  exit 0
fi

# Helper: run a command with sudo if not root
run_sudo() {
  if [ "$(id -u)" -eq 0 ]; then
    "$@"
  else
    if command -v sudo >/dev/null 2>&1; then
      sudo "$@"
    else
      echo "[chezmoi] sudo not available and not running as root; cannot install packages" >&2
      exit 1
    fi
  fi
}

# Detect and install via available package manager
install_jq() {
  # Debian/Ubuntu
  if command -v apt-get >/dev/null 2>&1; then
    export DEBIAN_FRONTEND=noninteractive
    run_sudo apt-get update -y
    run_sudo apt-get install -y --no-install-recommends jq
    return 0
  fi
  # Fedora/RHEL/CentOS
  if command -v dnf >/dev/null 2>&1; then
    run_sudo dnf install -y jq
    return 0
  fi
  if command -v yum >/dev/null 2>&1; then
    run_sudo yum install -y jq
    return 0
  fi
  # Arch
  if command -v pacman >/dev/null 2>&1; then
    run_sudo pacman -Sy --noconfirm jq
    return 0
  fi
  # Alpine
  if command -v apk >/dev/null 2>&1; then
    run_sudo apk add --no-cache jq
    return 0
  fi
  # macOS Homebrew
  if command -v brew >/dev/null 2>&1; then
    brew install jq
    return 0
  fi
  echo "[chezmoi] Unsupported platform or no known package manager to install jq" >&2
  return 1
}

if install_jq; then
  echo "[chezmoi] Installed jq successfully"
else
  echo "[chezmoi] Failed to install jq" >&2
  exit 1
fi
