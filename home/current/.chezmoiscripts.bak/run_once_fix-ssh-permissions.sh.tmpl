#!/usr/bin/env bash
# shellcheck shell=bash
# vim: set filetype=sh :
echo "⚙️ {{ .chezmoi.sourceFile | base }}"
#{{ includeTemplate "dot_config/ai/templates/shell/executable_executable.bash.tmpl" }}
{{- if ne (env "CI") "true" -}}
{{ if or (eq .chezmoi.os "linux") (eq .chezmoi.os "darwin") }}
# Ensure strict permissions on SSH directory and keys
set -euo pipefail

SSH_DIR="$HOME/.ssh"
mkdir -p "$SSH_DIR"
chmod 700 "$SSH_DIR"

# Fix permissions for private keys (no .pub extension)
if compgen -G "$SSH_DIR/*" > /dev/null; then
  # Private keys: 600
  find "$SSH_DIR" -maxdepth 1 -type f \
    ! -name "*.pub" \
    ! -name "known_hosts*" \
    ! -name "config" \
    -exec chmod 600 {} +
  # Public keys: 644
  find "$SSH_DIR" -maxdepth 1 -type f -name "*.pub" -exec chmod 644 {} +
fi

# SSH config should be 600 if present
if [ -f "$SSH_DIR/config" ]; then
  chmod 600 "$SSH_DIR/config"
fi

# known_hosts can be 644
if [ -f "$SSH_DIR/known_hosts" ]; then
  chmod 644 "$SSH_DIR/known_hosts"
fi
echo "✅ Finished: {{ .chezmoi.sourceFile | base }}"
exit 0
{{- /* End of the main conditional block */ -}}
{{- else -}}

# This script is intentionally left empty because the conditions for its execution were not met.
# Conditions: Not in CI and OS must be Linux.
echo "Skipping: {{ .chezmoi.sourceFile | base }} (conditions not met)"

{{- end -}}
{{ end }}
