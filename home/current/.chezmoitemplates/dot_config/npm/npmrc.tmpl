##############################################################################
#####  !!!! This file is managed by `chezmoi` do not edit directly !!!!  #####
##############################################################################

{{- $packageManager := "npm" -}}
{{- if contains "pnpm" .chezmoi.targetFile -}}
{{-   $packageManager = "pnpm" -}}
{{- else if contains "yarn" .chezmoi.targetFile -}}
{{-   $packageManager = "yarn" -}}
{{- end -}}

## (Unified Configuration for {{$packageManager}}) INI format

## https://docs.npmjs.com/cli/v11/using-npm/config
## You must set `$NPM_CONFIG_USERCONFIG` or pass the
##     argument `--userconfig $XDG_CONFIG_HOME/npm/npmrc` to use this
# ~/.npmrc

## https://pnpm.io/settings
# ~/.config/pnpm/rc (INI Format)


# ============================================================================
# General Configuration
# ============================================================================

# Registry URL (npm, pnpm, Yarn).
# The default is the public npm registry (https://registry.npmjs.org/).
#   You might want to change this if you are using a private registry or a mirror for faster downloads.
#registry=https://registry.npmjs.org/
## Use locally cached registry (Verdaccio) to allow for disconnected
## development (flight, outage, etc..) ~/$XDG_BIN_HOME/services/verdaccio-npm-registry.bash
registry=http://127.0.0.1:4873/

{{ if eq $packageManager "npm" -}}
# npm init configuration file (npm).  Ignored by pnpm and Yarn.
init-module={{ joinPath (env "XDG_CONFIG_HOME" | default (joinPath .chezmoi.homeDir ".config")) "npm" "config" "npm-init.js" }}
{{ end -}}

{{ if eq $packageManager "pnpm" -}}
# pnpm content-addressable store (pnpm only).
# defines the location of the content-addressable storage where pnpm saves
# all downloaded packages. This is a central part of pnpm's efficient disk space usage.
store-dir={{ joinPath (env "XDG_DATA_HOME" | default (joinPath .chezmoi.homeDir ".local" "share")) "pnpm" "store" "pnpm-store-v3" }}

# pnpm HTTP cache directory (pnpm only).
cache-dir={{ joinPath (env "XDG_CACHE_HOME" | default (joinPath .chezmoi.homeDir ".cache")) "pnpm-cache" }}

# Include tarball in lockfile (pnpm). No effect in npm or Yarn.
lockfile-include-tarball=true
{{ end -}}

{{ if or (eq $packageManager "npm") (eq $packageManager "yarn") -}}
# Directory for global installations (npm, Yarn).  pnpm does not use this.
prefix={{ joinPath (env "XDG_DATA_HOME" | default (joinPath .chezmoi.homeDir ".local" "share")) "npm" }}

# Proxy settings (npm, Yarn).  Specifies an HTTP proxy server to use for npm requests. Useful if you are behind a firewall.
#https-proxy=http://your-proxy-here:8080/

# Temporary directory (npm, Yarn).
tmp={{ joinPath (env "XDG_RUNTIME_DIR" | default (printf "/run/user/%d" .chezmoi.uid)) "npm" }}

# Cache directory (npm, Yarn).  pnpm uses store-dir and cache-dir.
# Specifies the directory where npm will store downloaded packages.
# Setting this explicitly, especially in CI/CD environments, can
# improve performance.
cache={{ joinPath (env "XDG_CACHE_HOME" | default (joinPath .chezmoi.homeDir ".cache")) "npm" }}
{{ end -}}

{{ if or (eq $packageManager "pnpm") (eq $packageManager "yarn") -}}
# Enable lockfile (pnpm, Yarn).  npm uses package-lock.json.
lockfile=true
{{ end -}}

# ============================================================================
#  Behavior
# ============================================================================

# Always require authentication (npm, pnpm, Yarn).
always-auth=false

# Save exact versions (npm, pnpm, Yarn).
save-exact=true

{{ if eq $packageManager "npm" -}}
# Prevents package-lock.json updates when installing a single package (npm).  No effect in pnpm or Yarn.
save=false
{{ end -}}

# Logging level (npm, pnpm, Yarn).
loglevel=warn

# Colorize output (npm, pnpm, Yarn).
color=true

# Show progress bar (npm, pnpm, Yarn).
progress=true

# ============================================================================
#  Security
# ============================================================================

# Audit for vulnerabilities (npm, pnpm, Yarn).
audit=true

# Minimum vulnerability level to fail audit (npm, pnpm, Yarn).
# Specifies the minimum severity level of vulnerabilities that will cause the audit to fail.
audit-level=high

{{ if eq $packageManager "npm" -}}
# Enable package provenance (npm >= v9).  Ignored by pnpm and Yarn.
provenance=true
{{ end -}}

{{ if eq $packageManager "pnpm" -}}
# Enforce strict peer dependencies (pnpm).  Yarn has similar behavior. npm is less strict by default.
strict-peer-dependencies=true
{{ end -}}

# ============================================================================
#  Publishing
# ============================================================================

# Publishing tag (npm, pnpm, Yarn).
tag=latest

# Package access level (npm, pnpm, Yarn).
access=public

# ============================================================================
#  Package Management (Filtering)
# ============================================================================

{{ if or (eq $packageManager "pnpm") (eq $packageManager "yarn") -}}
# Ignore specific packages during install (pnpm, Yarn).  Not directly supported by npm config.
# ignored-dependencies[]=lodash
# ignored-dependencies[]=jquery
{{ end -}}

# ============================================================================
# Filtering
# ============================================================================

# Only install production dependencies (npm, pnpm, Yarn).
# only-prod=true

# ============================================================================
#  Node-gyp (for native modules)
# ============================================================================

#  Specify the Python executable to use for node-gyp (if needed)
# python=$(pyenv which python)

# ============================================================================
#  Node Modules - OVERRIDDEN setting needs to be Unique per config
# ============================================================================

{{ if ne $packageManager "npm" -}}
# node-linker: This option is crucial for controlling how node_modules are structured.
#    - hoisted: (Recommended `pnpm`) Creates a flat node_modules structure by hoisting dependencies. This generally provides the best compatibility. Use symlinks (faster, more efficient).
#    - isolated: Creates a fully isolated node_modules structure for each package. This can improve reproducibility but may lead to compatibility issues.
#    - pnp: (Recommended `Yarn`) Enables Plug'n'Play
# n/a in npm, yarn classic, bun
# `hoisted` in pnpm
# `pnp` in Yarn Berry, but it has it's own config file or references ~/.npmrc which we're not using
{{ end -}}
{{ if eq $packageManager "pnpm" -}}
node-linker=hoisted
{{ else if eq $packageManager "yarn" -}}
node-linker=pnp
{{ end -}}
