#!/bin/env bash
# shellcheck bash strict
# vim: set ft=sh:
#{{ includeTemplate "dot_config/ai/templates/shell/executable_executable.bash.tmpl" . }}

set -euo pipefail

readonly _BIND_PORT_HOST=4873
readonly _BIND_PORT_CONTAINER=4873

# Start Verdaccio npm registry

## Check if Verdaccio is already running
#if pgrep -f "verdaccio" > /dev/null; then
#    echo "Verdaccio is already running."
#    exit 1
#fi

# Start Verdaccio
#verdaccio &
docker run -d --rm --name verdaccio \
    -p $_BIND_PORT_HOST:$_BIND_PORT_CONTAINER \
    -v ${XDG_CONFIG_HOME:-$HOME/.config}/verdaccio/config:/verdaccio/config \
    -v ${XDG_DATA_HOME:-$HOME/.local/share}/verdaccio/storage:/verdaccio/storage \
    -v ${XDG_DATA_HOME:-$HOME/.local/share}/verdaccio/plugins:/verdaccio/plugins \
    verdaccio/verdaccio

# Wait for Verdaccio to start
while ! curl -s http://localhost:$_BIND_PORT_HOST/ > /dev/null; do
    sleep 1
done

# Print Verdaccio URL
echo "Verdaccio started at http://localhost:$_BIND_PORT_HOST"
