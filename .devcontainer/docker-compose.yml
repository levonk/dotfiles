version: '3.8'

# Base settings live here. To customize locally without changing the repo,
# create a `.devcontainer/docker-compose.override.yml` alongside this file.
# Common overrides: ports, environment variables, and resource limits.
# Docs: https://docs.docker.com/compose/multiple-compose-files/
#       https://docs.docker.com/compose/extends/
services:
  dotfiles-test:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    container_name: dotfiles-testing-env
    hostname: dotfiles-container
    
    # Example overrides (put in docker-compose.override.yml):
    # ports:
    #   - "127.0.0.1:2222:22"
    # environment:
    #   - EXTRA_VAR=value
    
    # Environment variables
    environment:
      - DOTFILES_TEST_MODE=true
      - DEBUG_MODULE_LOADING=1
      - DEBUG_SOURCING=1
      - DEBUG_PERFORMANCE=1
      - DOTFILES_DEV_MODE=true
      - SHELL=/bin/zsh
      - TERM=xterm-256color
      - COLORTERM=truecolor
    
    # Volume mounts
    volumes:
      # Mount the entire dotfiles repository
      - ..:/workspace:cached
      # Persist user data between runs
      - dotfiles-home:/home/vscode
      # Cache directories for performance
      - dotfiles-cache:/home/vscode/.cache
      - dotfiles-local:/home/vscode/.local
      # Host mounts for development (read-only for safety)
      - ~/.config/git/config:/home/vscode/.config/git/config:ro
      - ~/.ssh:/home/vscode/.ssh:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    
    # Working directory
    working_dir: /workspace
    
    # Keep container running for interactive use
    tty: true
    stdin_open: true
    
    # Default command (runs setup and drops into zsh)
    command: >
      bash -c "
        echo 'ðŸ”§ Starting development environment...' &&
        .devcontainer/setup.sh &&
        echo 'ðŸ’¡ Development tips:' &&
        echo '   - Run tests: bats scripts/tests/shell-tests.bats' &&
        echo '   - Debug mode: DEBUG_MODULE_LOADING=1 zsh' &&
        echo '   - Performance test: .devcontainer/test.sh' &&
        echo '   - Exit container: exit' &&
        echo '' &&
        exec zsh
      "
    
    # Network configuration
    networks:
      - dotfiles-network
    
    # Resource limits (defaults; can be overridden in override file)
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'

    # Health check
    healthcheck:
      test: ["CMD", "zsh", "-c", "source ~/.zshrc && echo 'Health check passed'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Labels for organization
    labels:
      - "project=dotfiles"
      - "environment=testing"
      - "purpose=shell-configuration-testing"

  # Additional service for Bash testing
  dotfiles-bash-test:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    container_name: dotfiles-bash-env
    hostname: dotfiles-bash

    environment:
      - DOTFILES_TEST_MODE=true
      - DEBUG_MODULE_LOADING=1
      - SHELL=/bin/bash
      - TERM=xterm-256color

    volumes:
      - ..:/workspace:cached
      - dotfiles-bash-home:/home/vscode

    working_dir: /workspace
    tty: true
    stdin_open: true

    command: >
      bash -c "
        echo 'ðŸš Starting Bash testing environment...' &&
        .devcontainer/setup.sh &&
        echo 'âœ… Bash environment ready' &&
        exec bash
      "

    networks:
      - dotfiles-network

    labels:
      - "project=dotfiles"
      - "environment=development"
      - "shell=bash"

  # Optional: Additional service for CI/CD testing
  dotfiles-ci:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    container_name: dotfiles-ci-runner
    hostname: dotfiles-ci
    
    environment:
      - DOTFILES_TEST_MODE=true
      - DEBUG_MODULE_LOADING=0
      - CI=true
      - SHELL=/bin/bash
    
    volumes:
      - ..:/workspace:ro  # Read-only for CI
    
    working_dir: /workspace
    
    # Run tests and exit
    command: >
      bash -c "
        echo 'ðŸš€ Starting CI test run...' &&
        .devcontainer/setup.sh &&
        scripts/tests/devcontainer-test.sh &&
        echo 'âœ… CI tests completed successfully!'
      "
    
    networks:
      - dotfiles-network
    
    # Don't restart on failure for CI
    restart: "no"
    
    labels:
      - "project=dotfiles"
      - "environment=ci"
      - "purpose=automated-testing"

# Named volumes for persistence
volumes:
  dotfiles-home:
    driver: local
    labels:
      - "project=dotfiles"
      - "type=user-data"
  
  dotfiles-cache:
    driver: local
    labels:
      - "project=dotfiles"
      - "type=cache"
  
  dotfiles-local:
    driver: local
    labels:
      - "project=dotfiles"
      - "type=local-data"
  dotfiles-bash-home:
    driver: local
    labels:
      - "project=dotfiles"
      - "type=bash-user-data"

# Network for service communication
networks:
  dotfiles-network:
    driver: bridge
    labels:
      - "project=dotfiles"
